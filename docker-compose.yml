services:
  dragonscales:
    build: .
    container_name: dragonscales
    depends_on:
      - cache
      - vault
    volumes:
      - ./certs:/app/certs:ro
    command: python -m dragonscales.ui_app
    ports:
      - "8443:8443"
    environment:
      - REDIS_USERNAME=${REDIS_USERNAME:-default}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-dev-redis-password}
      - CACHE_URL=redis://${REDIS_USERNAME:-default}:${REDIS_PASSWORD:-dev-redis-password}@cache:6379/0
      - VAULT_ADDR=http://vault:8200
      - VAULT_ROLE_ID=${VAULT_ROLE_ID:-}
      - VAULT_SECRET_ID=${VAULT_SECRET_ID:-}
      - VAULT_TOKEN=${VAULT_TOKEN:-}
  cache:
    image: redis:7-alpine
    container_name: dragonscales-cache
    volumes:
      - cache-data:/data
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:-dev-redis-password}"]
  vault:
    image: hashicorp/vault:1.16
    container_name: dragonscales-vault
    cap_add:
      - IPC_LOCK
    ports:
      - "8200:8200"
    volumes:
      - vault-data:/vault/data
      - ./vault/config.hcl:/vault/config/config.hcl:ro
    command: vault server -config=/vault/config/config.hcl
    environment:
      - VAULT_ADDR=http://vault:8200
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 5s
      timeout: 3s
      retries: 20
volumes:
  cache-data:
  vault-data:
